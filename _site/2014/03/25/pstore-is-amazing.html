<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>PStore is Amazing</title>
  <meta name="description" content="TL\DR; Want to play with an object database? Skip Maglev and play with PStore.">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/2014/03/25/pstore-is-amazing.html">
  <link rel="alternate" type="application/rss+xml" title="Geek-O-System" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">

    <a class="site-title" href="/">Geek-O-System</a>

    <nav class="site-nav">
      <span class="menu-icon">
        <svg viewBox="0 0 18 15" width="18px" height="15px">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </span>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">PStore is Amazing</h1>
    <p class="post-meta"><time datetime="2014-03-25T21:35:00-06:00" itemprop="datePublished">Mar 25, 2014</time></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h2 id="tldr-want-to-play-with-an-object-database-skip-maglev-and-play-with-pstore">TL\DR; Want to play with an object database? Skip Maglev and play with PStore.</h2>

<p>My last few posts have been about my adventures of trying to get Puma to run on <a href="http://maglev.github.io/">Maglev</a>. That adventure began because <a href="https://twitter.com/Johnny_T">Johnny T</a> infected my brain with the the idea of persistent objects.</p>

<!--more-->

<p>The idea that I could stop making applications in terms of relational tables and just create object graphs that can be persisted with ACID transactions.</p>

<h1 id="the-city-on-a-hill">The City On a Hill</h1>

<p>As I explored this idea I was awe struck to realize how much of my code, and how much of my time thinking about code was being spent on that barrier. I had been programming with a database in mind since the early days of my programming experience. I had brainwashed myself into thinking of my code in terms of the relational tables that would store my data.</p>

<p>You might think that removing the <a href="http://en.wikipedia.org/wiki/Object-relational_impedance_mismatch">Object-Relational Impedance Mismatch</a> is a matter of convenience. Clearly not all of the logic you spend your time working on is focused on bridging that gap. So does it give you an extra 10% or maybe even 20% of your programming bandwidth back?</p>

<p>In my experience thus far, programming purely with objects feels like getting 50% of my bandwidth back.</p>

<h1 id="the-hill">The hill</h1>

<p>Unfortunately the reality of using Maglev today is that you will spend most of your time shaving yaks.</p>

<p><em>Want to use RSpec to run a test?</em> It raises an exception on Maglev.</p>

<p><em>Want to use Virtus?</em> The gem doesn’t build on Maglev.</p>

<p><em>Want to use Puma?</em> See the recent posts.</p>

<p>The constant yak shave almost killed my enthusiasm for the dream.</p>

<h1 id="an-alternate-path">An Alternate Path</h1>

<p>About a month ago I took some time off of Maglev to prepare a <a href="http://hqmq.github.io/presentation-accidental-design/">presentation</a> for <a href="http://mtnwestrubyconf.org/">Mountain West Ruby Conf</a>. I was selected as a backup speaker in case one of the main speakers had an emergency, but the conference ran smoothly and I never ended up giving the presentation.  During my time off I found myself wondering if there were a way for me to experiment with transparent object persistence without using Maglev.</p>

<p>After much googling that turned up nothing of interest I remembered <a href="http://www.ruby-doc.org/stdlib-2.1.1/libdoc/pstore/rdoc/PStore.html">PStore</a> which is in the Ruby Standard Library!  It supports thread-safe transactional access to a persistent root. It even notices if the same object exists multiple times in the object graph and will maintain that referential integrity. I love you PStore!</p>

<p>The main difference from a true object database is that it does not persist object definitions. So if you define a class and then make a bunch of instances and save them, you can only pull them back out again if your current process has loaded the definition for that class. This has turned out not to be a huge limitation in terms of my experimentation right now. I’m already used to tools that have to load my whole app into memory on boot.</p>

<h1 id="a-sample">A Sample</h1>

<p>I have begun trying to make a new backend for <a href="http://golf.riesd.com/">my golf score app</a> since it is a <a href="https://github.com/hqmq/golf-score-grapher">smallish app</a> with a few quirks. It makes a pretty easy testbed for trying out new ideas, while keeping focused on a defined set of functionality.</p>

<p>To begin with I defined a basic <a href="http://www.sinatrarb.com/">Sinatra</a> app and setup the config.ru file to include a middleware which wraps every request in a PStore transaction.</p>

<p>```ruby config.ru
require ‘my_sinatra_app’</p>

<p>DB = PStore.new(“tmp/golfscore_grapher.pstore”, true)</p>

<p>class DbTransactionMiddleware
  def initialize(app)
    @app = app
  end</p>

<p>def call(env)
    DB.transaction do
      @app.call(env)
    end
  end
end</p>

<p>use DbTransactionMiddleware
run GolfscoreGrapher</p>
<div class="highlighter-rouge"><pre class="highlight"><code>
I immediately asked myself how bad the performance will be if I have to access the whole pstore all the time. So I wrote a quick rake task to import some data, made a sinatra action that accessed my pstore and generated some JSON and then benchmarked it.

```ruby
# the sinatra action
get '/players.json' do
  JSON.generate(DB[:players].map(&amp;:attributes))
end
</code></pre>
</div>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>ab -n 1000 -c 1 <span class="s1">'http://127.0.0.1:9292/players.json'</span>
...
Time per request:       4.813 <span class="o">[</span>ms] <span class="o">(</span>mean<span class="o">)</span>
...
Connection Times <span class="o">(</span>ms<span class="o">)</span>
              min  mean[+/-sd] median   max
Connect:        0    0   0.0      0       0
Processing:     4    5   1.7      4      32
Waiting:        3    5   1.7      4      32
Total:          4    5   1.7      4      32
</code></pre>
</div>

<h1 id="so-why-do-we-need-maglev">So Why Do We Need Maglev?</h1>

<p>Clearly the PStore approach is not going to scale very well. Loading the full database on every request will become a bottlneck that can’t be ignored.  But as a way to explore what it feels like to program with persistent objects it is <em>amazing</em>.</p>

<p>At some point I hope that an open source project will make a viable alternative to using the Gemstone system. The pure object persistence Maglev represents requires language level bindings so that new object ids don’t collide with persisted object ids (plus many other concerns). Those are not easy problems to solve, but I hope that someone besides the old school of Smalltalkers will make it possible.</p>

  </div>

  
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <h3>tags</h3>
        <div id="tag-cloud">
          <a href="/tag/apprenticeship.html" class="set-1">apprenticeship</a> <a href="/tag/artoo.html" class="set-1">artoo</a> <a href="/tag/aws.html" class="set-1">aws</a> <a href="/tag/beagleboneblack.html" class="set-1">beagleboneblack</a> <a href="/tag/development.html" class="set-1">development</a> <a href="/tag/digispark.html" class="set-1">digispark</a> <a href="/tag/friendly-bot.html" class="set-1">friendly-bot</a> <a href="/tag/hiring.html" class="set-1">hiring</a> <a href="/tag/interviewing.html" class="set-1">interviewing</a> <a href="/tag/maglev.html" class="set-2">maglev</a> <a href="/tag/mentoring.html" class="set-1">mentoring</a> <a href="/tag/opencv.html" class="set-1">opencv</a> <a href="/tag/programming.html" class="set-1">programming</a> <a href="/tag/puma.html" class="set-1">puma</a> <a href="/tag/robotics.html" class="set-1">robotics</a> <a href="/tag/ruby.html" class="set-5">ruby</a> <a href="/tag/spyglass.html" class="set-1">spyglass</a> <a href="/tag/tab-separated.html" class="set-1">tab-separated</a>
        </div>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="contact-list">
          <li>
            
              Geek-O-System
            
            </li>
            
            <li><a href="mailto:michael@riesd.com">michael@riesd.com</a></li>
            
        </ul>
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/mmmries"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">mmmries</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/mmmries"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">mmmries</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <a href="http://showoff.riesd.com/">
          <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <style>
              @-webkit-keyframes spin {
                0% { -webkit-transform: rotate(0deg); }
                100% { -webkit-transform: rotate(360deg); }
              }
              .pupil {
                -webkit-transform-origin: 100% 120%;
                -webkit-animation: spin 1s cubic-bezier(1,0,0.5,1) 0s infinite;
              }
            </style>
            <rect fill="lightgreen" height="100" width="100" x="0" y="0"></rect>
            <circle cx="50" cy="130" r="80"></circle>
            <circle cx="50" cy="130" fill="grey" r="60"></circle>
            <g>
              <circle cx="22" cy="22" r="15"></circle>
              <circle cx="22" cy="22" fill="grey" r="9"></circle>
            </g>
            <g transform="translate(55,0)">
              <circle cx="22" cy="22" r="15"></circle>
              <circle cx="22" cy="22" fill="grey" r="9"></circle>
            </g>
            <polygon fill="black" points="5.00000000000000000000e+01 9.17000000000000028422e+01 7.73650324319193885003e+01 8.03650324319193885003e+01 8.87000000000000028422e+01 5.30000000000000000000e+01 7.73650324319193885003e+01 2.56349675680806114997e+01 5.00000000000000071054e+01 1.42999999999999971578e+01 2.26349675680806114997e+01 2.56349675680806043943e+01 1.12999999999999971578e+01 5.29999999999999928946e+01 2.26349675680806043943e+01 8.03650324319193885003e+01"></polygon>
            <polygon fill="lightgrey" points="5.00000000000000000000e+01 9.00000000000000000000e+01 7.82842712474619020213e+01 7.82842712474619020213e+01 9.00000000000000000000e+01 5.00000000000000000000e+01 7.82842712474619020213e+01 2.17157287525381015314e+01 5.00000000000000071054e+01 1.00000000000000000000e+01 2.17157287525381015314e+01 2.17157287525380908733e+01 1.00000000000000000000e+01 4.99999999999999928946e+01 2.17157287525380908733e+01 7.82842712474619020213e+01"></polygon>
            <g>
              <circle cx="35" cy="40" r="10"></circle>
              <circle cx="35" cy="40" fill="white" r="4"></circle>
              <circle class="pupil" cx="33" cy="38" r="2"></circle>
            </g>
            <g transform="translate(30,0)">
              <circle cx="35" cy="40" r="10"></circle>
              <circle cx="35" cy="40" fill="white" r="4"></circle>
              <circle class="pupil" cx="33" cy="38" r="2"></circle>
            </g>
            <polygon points="5.00000000000000000000e+01 6.60000000000000000000e+01 5.77942286340599480354e+01 5.25000000000000000000e+01 4.22057713659400519646e+01 5.25000000000000000000e+01"></polygon>
            <rect fill="black" height="2" transform="rotate(170, 50,71)" width="20" x="38" y="70"></rect>
            <rect fill="black" height="1" width="20" x="25" y="28"></rect>
            <rect fill="black" height="1" transform="rotate(195, 66,28)" width="20" x="55" y="28"></rect>
          </svg>
        </a>
      </div>
    </div>

  </div>

</footer>




  </body>

</html>
